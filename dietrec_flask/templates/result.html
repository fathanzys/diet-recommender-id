{% extends "base.html" %}

{% block content %}
<script id="backend-data" type="application/json">
{
  "days": {{ chart_days | tojson }},
  "totals": {{ chart_kcal | tojson }},
  "radar": {{ chart_radar | tojson }},
  "target": {{ tdee_target }}
}
</script>

<div class="bg-slate-50 min-h-screen py-10 font-sans text-slate-800 pb-32">

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mb-10">
    <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm relative overflow-hidden">
      <div
        class="absolute top-0 right-0 w-96 h-96 bg-gradient-to-br from-brand-50 to-transparent rounded-full blur-3xl -mr-20 -mt-20 opacity-70">
      </div>

      <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span
              class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-brand-50 text-brand-700 text-xs font-bold uppercase tracking-wider border border-brand-100">
              <span class="relative flex h-2 w-2">
                <span
                  class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-brand-500"></span>
              </span>
              Analisis Personal Selesai
            </span>
            <span class="text-slate-400 text-xs font-medium">{{ meta.sex }} â€¢ {{ meta.age }} Th â€¢ {{ meta.weight }}
              Kg</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight leading-tight">
            Rencana Gizi Sehat Anda ðŸŒ±
          </h1>
          <p class="text-slate-600 mt-3 text-lg max-w-2xl leading-relaxed">
            Untuk mencapai target <span class="font-bold text-brand-700 border-b-2 border-brand-200">{{ meta.goal|title
              }}</span>,
            tubuh Anda memerlukan strategi asupan energi yang tepat. Berikut adalah panduan lengkapnya.
          </p>
        </div>

        <div class="flex flex-wrap gap-3">
          <a href="{{ url_for('input_page') }}"
            class="inline-flex items-center justify-center px-5 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition shadow-sm group">
            <svg class="w-4 h-4 mr-2 text-slate-400 group-hover:text-slate-600" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12">
              </path>
            </svg>
            Ubah Profil
          </a>
          <a href="{{ url_for('export_pdf') }}"
            class="inline-flex items-center justify-center px-6 py-2.5 bg-slate-900 text-white rounded-xl text-sm font-bold hover:bg-slate-800 transition shadow-lg shadow-slate-900/20 group">
            <svg class="w-4 h-4 mr-2 group-hover:translate-y-0.5 transition-transform" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Simpan PDF
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">

      <div
        class="bg-gradient-to-br from-brand-500 to-emerald-600 rounded-2xl p-7 text-white shadow-xl shadow-brand-500/20 relative overflow-hidden group hover:shadow-2xl transition duration-300">
        <div
          class="absolute right-0 top-0 p-6 opacity-10 text-white transform group-hover:scale-110 transition duration-700">
          <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
              clip-rule="evenodd"></path>
          </svg>
        </div>

        <div class="relative z-10 h-full flex flex-col justify-between">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <div class="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm">
                <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z">
                  </path>
                </svg>
              </div>
              <p class="text-brand-50 text-xs font-bold uppercase tracking-wider">Target Harian</p>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
              <span class="text-6xl font-black tracking-tighter">{{ meta.tdee }}</span>
              <span class="text-xl font-medium text-brand-100">kkal</span>
            </div>
          </div>

          <div class="mt-6 pt-4 border-t border-white/10">
            <p class="text-sm text-brand-50 font-medium leading-relaxed">
              Batas asupan energi harian agar berat badan Anda <span
                class="text-white font-bold underline decoration-brand-300 decoration-2 underline-offset-2">{{ 'turun'
                if meta.goal == 'cut' else 'naik' if meta.goal == 'bulk' else 'stabil' }}</span>.
            </p>
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-2xl p-7 border border-slate-200 shadow-sm flex flex-col justify-between hover:border-brand-200 transition duration-300">
        <div>
          <div class="flex items-center gap-2 mb-6">
            <div class="p-1.5 bg-blue-50 text-blue-600 rounded-lg">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <h4 class="text-slate-800 font-bold text-sm uppercase tracking-wide">Status Tubuh</h4>
          </div>

          <div class="space-y-5">
            <div class="flex justify-between items-center group">
              <div>
                <p class="text-xs text-slate-500 font-semibold mb-0.5">Indeks Massa Tubuh (BMI)</p>
                <div class="flex items-center gap-2">
                  <span class="text-3xl font-black text-slate-900">{{ meta.bmi }}</span>
                  <span class="px-2.5 py-1 text-[10px] font-bold rounded-full uppercase tracking-wide 
                    {% if 'Normal' in meta.bmi_cat %} bg-emerald-100 text-emerald-700
                    {% elif 'Under' in meta.bmi_cat %} bg-blue-100 text-blue-700
                    {% else %} bg-orange-100 text-orange-700 {% endif %}">
                    {{ meta.bmi_cat }}
                  </span>
                </div>
              </div>
            </div>

            <div class="pt-4 border-t border-slate-100">
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-xs text-slate-500 font-semibold mb-0.5">Metabolisme Dasar (BMR)</p>
                  <span class="text-2xl font-bold text-slate-900">{{ meta.bmr }} <span
                      class="text-sm font-normal text-slate-400">kkal</span></span>
                </div>
                <div class="text-right max-w-[120px]">
                  <p class="text-[10px] text-slate-400 leading-tight">Energi yang dibakar tubuh saat tidur/istirahat.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="bg-slate-900 rounded-2xl p-7 shadow-lg text-white flex flex-col justify-center relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-brand-500 rounded-full blur-3xl -mr-10 -mt-10 opacity-20"></div>

        <div class="relative z-10">
          <h4 class="font-bold mb-5 flex items-center gap-2 text-white">
            <svg class="w-5 h-5 text-brand-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
              </path>
            </svg>
            Kustomisasi Cepat
          </h4>

          <div class="space-y-4">
            <div>
              <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1.5 block">Filter
                Makanan</label>
              <div class="relative">
                <select id="liveHalal"
                  class="w-full appearance-none bg-slate-800 border border-slate-700 rounded-xl text-sm font-medium text-white focus:ring-2 focus:ring-brand-500 focus:border-brand-500 p-3 pl-4 cursor-pointer hover:bg-slate-700 transition">
                  <option value="ya" {% if meta.halal=='Ya' %}selected{% endif %}>ðŸŸ¢ Hanya Menu Halal</option>
                  <option value="tidak" {% if meta.halal=='Tidak' %}selected{% endif %}>âšª Tampilkan Semua</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
            </div>

            <div class="hidden">
              <select id="liveAlergi" multiple>{% for opt in allergies_opts %}<option value="{{ opt }}" {% if opt in
                  meta.allergies %}selected{% endif %}>{{ opt }}</option>{% endfor %}</select>
              <input id="liveDays" value="{{ meta.days }}">
              <select id="livePenyakit" multiple>{% for opt in diseases_opts %}<option value="{{ opt }}" {% if opt in
                  meta.diseases %}selected{% endif %}>{{ opt }}</option>{% endfor %}</select>
            </div>

            <button id="btnApply"
              class="w-full py-3 bg-brand-600 hover:bg-brand-500 text-white text-sm font-bold rounded-xl transition shadow-lg shadow-brand-900/50 mt-2 flex items-center justify-center gap-2">
              <span>Terapkan</span>
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-12">
      <div class="md:col-span-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col">
        <h4 class="text-sm font-bold text-slate-800 mb-1">Piring Makan Ideal</h4>
        <p class="text-xs text-slate-500 mb-6">Proporsi Karbohidrat, Protein, dan Lemak.</p>
        <div class="flex-grow flex items-center justify-center relative min-h-[180px]">
          <canvas id="donutTarget"></canvas>
          <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <span id="textKarbo" class="text-3xl font-black text-slate-800">50%</span> 
            <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Karbo</span>
          </div>
        </div>
      </div>

      <div class="md:col-span-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h4 class="text-sm font-bold text-slate-800 mb-1">Konsistensi Asupan Kalori</h4>
            <p class="text-xs text-slate-500">Perbandingan total kalori menu vs target harian Anda.</p>
          </div>
          <div class="flex items-center gap-4 text-xs font-medium">
            <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-brand-500"></span> Menu
              Terpilih</div>
            <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-slate-300"></span> Target
            </div>
          </div>
        </div>
        <div class="flex-grow min-h-[180px]">
          <canvas id="barKcal"></canvas>
        </div>
      </div>
    </div>

    <div class="space-y-8">
      <div class="flex items-center gap-3 pb-4 border-b border-slate-200">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-xl bg-brand-50 text-brand-600 font-bold shadow-sm border border-brand-100">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-bold text-slate-900">Jadwal Menu {{ meta.days }} Hari</h2>
          <p class="text-sm text-slate-500">Metode Gizi Seimbang (4 Sehat 5 Sempurna)</p>
        </div>
      </div>

      {% for day in plan %}
      <div
        class="bg-white rounded-2xl shadow-card border border-slate-200 overflow-hidden transition hover:shadow-lg duration-300">
        <div
          class="bg-slate-50/50 px-6 py-4 border-b border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <span
              class="flex h-9 w-9 items-center justify-center bg-slate-800 text-white rounded-lg font-bold text-sm shadow-md">
              {{ day['day'] }}
            </span>
            <div>
              <h3 class="font-bold text-base text-slate-800">Hari ke-{{ day['day'] }}</h3>
              <p class="text-xs text-slate-500">Total Energi: <span class="font-bold text-brand-600">{{
                  day['meals']|sum(attribute='total.kcal')|int }} kkal</span></p>
            </div>
          </div>

          <div class="flex gap-2">
            <span
              class="px-2 py-1 bg-white border border-slate-200 rounded-md text-[10px] font-bold text-slate-500 uppercase">
              P: {{ day['meals']|sum(attribute='total.protein_g')|int }}g
            </span>
            <span
              class="px-2 py-1 bg-white border border-slate-200 rounded-md text-[10px] font-bold text-slate-500 uppercase">
              L: {{ day['meals']|sum(attribute='total.fat_g')|int }}g
            </span>
            <span
              class="px-2 py-1 bg-white border border-slate-200 rounded-md text-[10px] font-bold text-slate-500 uppercase">
              K: {{ day['meals']|sum(attribute='total.carb_g')|int }}g
            </span>
          </div>
        </div>

        <div class="divide-y divide-slate-100">
          {% for meal in day['meals'] %}
          <div class="p-6 transition hover:bg-brand-50/10">
            <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-4">
              <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wide w-fit shadow-sm
                {% if meal['name'] == 'Sarapan' %} bg-orange-50 text-orange-700 border border-orange-100
                {% elif meal['name'] == 'Makan Siang' %} bg-sky-50 text-sky-700 border border-sky-100
                {% else %} bg-indigo-50 text-indigo-700 border border-indigo-100 {% endif %}">
                {{ meal['name'] }}
              </span>
              <div class="h-px bg-slate-100 flex-grow hidden sm:block"></div>
              <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100">
                Â± {{ meal['total']['kcal']|int }} kkal
              </span>
            </div>

            <div class="overflow-hidden rounded-xl border border-slate-200/60">
              <table class="w-full text-sm text-left">
                <thead class="bg-slate-50/80 text-[10px] uppercase font-bold text-slate-500">
                  <tr>
                    <th class="px-4 py-2.5 w-32">Kategori</th>
                    <th class="px-4 py-2.5">Menu Pilihan</th>
                    <th class="px-4 py-2.5 text-right w-24">Porsi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-50 bg-white">
                  {% for item in meal['items'] %}
                  <tr class="group hover:bg-slate-50 transition">
                    <td class="px-4 py-3 text-slate-400 text-xs font-medium group-hover:text-slate-600">
                      {{ item['class']|capitalize }}
                    </td>
                    <td class="px-4 py-3 font-semibold text-slate-700 group-hover:text-brand-700">
                      {{ item['name'] }}
                    </td>
                    <td class="px-4 py-3 text-right text-slate-600 font-mono text-xs">
                      {{ item['portion_g'] }}g
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="mt-16 p-5 bg-blue-50 border border-blue-100 rounded-2xl flex flex-col sm:flex-row gap-4 items-start">
      <div class="p-2.5 bg-white text-blue-600 rounded-xl shadow-sm border border-blue-100 flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div>
        <h4 class="text-blue-900 font-bold text-sm mb-1">Catatan Penting</h4>
        <p class="text-xs text-blue-800 leading-relaxed text-justify sm:text-left">
          Aplikasi NutriPlan menggunakan data berbasis <b>Tabel Komposisi Pangan Indonesia (TKPI 2020)</b> dan standar
          <b>Angka Kecukupan Gizi (AKG)</b>.
          Hasil rekomendasi bersifat estimasi untuk membantu perencanaan makan sehat bagi populasi umum.
          Bagi individu dengan kondisi medis khusus (seperti gagal ginjal, diabetes lanjut, dll), sangat disarankan
          untuk berkonsultasi langsung dengan dokter spesialis gizi klinik.
        </p>
      </div>
    </div>

  </div>
</div>

<div class="hidden"><canvas id="radarMacro"></canvas></div>
{% endblock %}